= Смена аватарки по клику =

ver 1.0 (в разработке)

%toc

== Термины, обозначения и иерархия ==

== Концепция ==

Аватарки пользователя хранятся в альбоме, автоматически создаваемом системой при регистрации профиля. По умолчанию настройки видимости альбома — только профилю. Альбом аватарок является обычным альбомом, который можно расшарить другим пользователям, редактировать, комментировать и т.п.

В данной спецификации рассматривается только управление аватарками через диалог. Управление через альбом — содержит функционал обычного альбома, и здесь не затрагивается.

===== Нюансы =====

* Для альбома аватарок устанавливается имя по умолчанию «Аватарки» (для других языков — в соответствии с их требованиями).
    * _Для альбомов нет такого функционала, как перевод. Варианты:_
        * _Оборачивать все имена альбомов в _()_
            * _- есть небольшой шанс, что переведётся то, что не должно,_
            * _- лишние издержки на вызов,_
        * _прикрутить троты к альбомам_
            * _- ИМХО, слишком накладно в плане запросов к БД и объёму хранимых данных (по сути повторяющихся),_
            * _- дополнительная головная боль с группировками и дистинктами при выборке альбомов для убирания дубляжей._
        * _сделать отдельный тип альбомов (подкласс или флаговое поле) типа системные альбомы, и работать с ними особым образом_
            * _+ достаточно универсально,_
            * _+ должно быть достаточно быстро (проверка булева флага намного быстрее безусловного вызова переводов),_
            * _+ без накладных расходов тротов, возможность навешивания дополнительно логки._
* Привязка альбома аватарки к механизму управления аватарками происходит по id альбома (т.е. пользователь может как угодно переименовывать альбом).
    * _В профиль добавляется поле `avatar_album_id`_
* Альбом аватарок нельзя удалить, но в нем можно удалить все изображения.
    * _ещё плюс за флаговое поле `is_system`, если стоит, до добавляем логику: неудаляемо_
* Существует дефолтное изображение аватарки, которое используется если:
    * Пользователь удалил все изображения в альбоме аватарки.
    * Пользователь удалил выбранное текущим изображение в альбоме аватарки.
    * Пользователь не добавлял изображения в альбом аватарок.
    * _Дефолтное *системное* изображение, или юзер отдельно его задаёт вне альбома?_
* Дефолтное изображение аватарки не добавляется в альбом аватарок.
* Через стандартный механизм управления альбомами нельзя менять текущую аватарку.
* Так как изображения определяются URL, есть смысл загружать список сразу всех URL аватарок из альбома.
    * _Не понял, то есть как загружать? В смысле в плане оптимизации запросов — в память? Или в отдельном поле профиля хранить URL на все его авы? Поясните мысль._

== Взаимодействие ==

=== Отображение аватарки текущего профиля в header-е ===

===== Мокапы =====

{{anchor(мокап-общий)}}

====== Диалог управления аватаркой ======

!Avatar-общий.png!

{{anchor(мокап-профиль-просмотр)}}

====== Аватарка на странице профиля (просмотр) ======

!Avatar-управление_профилем__просмот_.png!

{{anchor(мокап-профиль-редактирование)}}

====== Аватарка на странице профиля (редактирование) ======

!Avatar-управление_профилем__редактирование_.png!

===== Права =====

Только владелец профиля может управлять аватаркой профиля.

===== Точки входа =====

Аватарка текущего профиля видна практически на всех страницах (определяется наполнением страниц и авторизацией пользователя) и расположена в header-е страницы. Так же, дополнительно аватарка профиля доступна на странице редактирования профиля (см. [[M-profile-avatar-dialog#мокап-общий|мокап 1]], [[M-profile-avatar-dialog#мокап-профиль-просмотр|мокап 2]] и [[M-profile-avatar-dialog#мокап-профиль-редактирование|мокап 3]]).

===== Функционирование =====

Авторизованный пользователь открывает любую страниц сайта. Система отображает аватарку текущего профиля в header-е. При этом, в правом нижнем углу аватарки размещается иконка управления аватаркой.

Пользователь наводит мышку на аватарку в header-е (вне зоны иконки управления) и кликает на нее. Система перенаправляет пользователя на страницу профиля.

Пользователь наводит мышку на аватарку в header-е (на иконку управления) и кликает на нее. Система (при наведении мышки) делает иконку управления ярче, а по клику на иконку управления — открывает диалог управления аватарками.

===== Нюансы =====

* Предусмотреть фоновое кэширование аватарок после загрузки изображений видимой страницы.
    * _В альбомах уже есть кеширование на уровне ФС. Можно добавить браузерное в виде E-Tags/If-Modified-Since._

=== Смена аватарки текущего пользователя ===

===== Права =====

Только владелец профиля может управлять аватаркой профиля.

===== Точки входа =====

Через аватарку текущего профиля, доступную практически на всех страницах (определяется наполнением страниц и авторизацией пользователя) и расположенную в header-е страницы. Так же через аватарку на странице редактирования профиля (см. [[M-profile-avatar-dialog#мокап-общий|мокап 1]], [[M-profile-avatar-dialog#мокап-профиль-просмотр|мокап 2]] и [[M-profile-avatar-dialog#мокап-профиль-редактирование|мокап 3]]).

===== Функционирование =====

Пользователь кликает на не выделенную аватарку в диалоге управления аватарками. Система подсвечивает выбранную аватарку, и обновляет изображение в header-е.

Пользователь кликает на уже выделенную аватарку в диалоге управления аватарками. Система снимает подсветку с аватарки, текущей устанавливает дефолтное изображение и обновляет изображение в header-e.

Пользователь делает double-click на аватарку, или click + нажимает кнопку «Выбрать». Система устанавливает выбранную аватарку как текущую.

Пользователь нажимает «нет», отказываясь от смены аватарки. Система восстанавливает изображение старой аватарки (если пользователь его изменил).

===== Нюансы =====

* Аватарки в диалоге имеют размер, соответствующий размеру аватарки в правом блоке (что бы пользователь сразу видел аватарку, как она видна другим пользователям).
* Список аватарок можно сортировать по имени и дате добавления. По умолчанию — по имени.
* Сортировка происходит при смене вида сортировки в выпадающем списке.

=== Управление аватарками через диалог выбора аватарки ===

===== Права =====

Только владелец профиля может управлять аватаркой профиля.

===== Точки входа =====

Управление аватарками доступно через соответствующий диалог, который можно вызвать практически на любой странице (определяется наполнением страниц и авторизацией пользователя).

===== Функционирование =====

Пользователь нажимает «Добавить картинку». Система открывает диалог выбора изображений.

Пользователь выбирает добавляемые изображения в диалоге и нажимает «ок». Система заливает изображения на сервер, добавляет их в альбом и обновляет список изображений в диалоге.

Пользователь нажимает на иконку управления «удалить изображение». Система выводит запрос подтверждения удаления, и если пользователь подтверждает операцию — удаляет изображение из альбома и из диалога управления аватарками.
 
_Добавить автокадрирование/ручное кадрирование авы, чтобы можно например было залить фотку в полный рост и на аву обрезать только лицо? Обсудить с Виталиком, т.к. он обработкой изображений заниался._

===== Нюансы =====

* После вставки изображений пагинация переключается на страницу, с первой вставленной аватаркой.
    * _Пока не уверен, может быть сложнореализуемо._
* Иконка управления «удалить изображение» размещается в правом верхнем углу каждой аватарки в диалоге. Поведение аналогично иконке на аватарке пользователя в header-е.
    * Иконка становится ярче при наведении на нее.
* Если удаляется аватарка, являющаяся текущей — то активной становится дефолтная аватарка.

=== Управление аватаркой профиля на странице редактирования профиля ===

===== Права =====

Только владелец профиля может управлять аватаркой профиля.

===== Точки входа =====

Аватарка профиля на странице редактирования профиля.

===== Функционирование =====

Пользователь наводит мышку на аватарку в профиле (режим просмотра или редактирования) и кликает на нее. Система открывает диалог управления аватарками.

Пользователь наводит мышку на иконку управления «удалить аватарку» в правом верхнем углу. Система выводит запрос подтверждения удаления, и если пользователь подтверждает операцию — удаляет изображение из альбома. Текущей становится дефолтная аватарка.

===== Нюансы =====

* Старый механизм управления аватарками удаляется.

== Общая информация ==

===== Нюансы =====

* Все тесты приведены для примера и «отображения сути», конечный вариант согласовывать с принятой в проекте стилистикой и т.п.
* Все действия с пользователями происходят с использованием AJAX (смена страницы блока, назначение роли, перемещение между гуппами и т.п.).
* Там, где это необходимо (удаление аватарки, заливка изображений и т.п.) — пользователь информируется о ходе/результатах выполнения операции при помощи системы уведомлений Unite.
* Поведение иконок управления — однотипное во всех ситуациях:
    * В исходном состоянии она слабо-заметна (только что бы обозначить свое наличие).
    * При наведении на иконку (не изображение, на которое она наложена, а именно на область иконки) она становится ярче, и появляется тултип с описанием действия, привязанного к иконке.
    * По клику на иконку выполняется связанное с ней действие.
    * Клик на само изображение (вне области иконки) обрабатывается как и прежде.
    * _Может иконку управления эту на текущей аве профиля (в хедере страницы которая) не отображать, если нет наведения мышей? А то будет неэстетично прикрывать аву, что может быть не всегда приятно/удобно._
